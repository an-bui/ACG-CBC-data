---
title: "CBC 2021 data cleaning"
author: "An Bui"
date: "1/28/2022"
output:
  html_document:
    toc: true
    toc_depth: 4
    toc_float:
      collapsed: false
    theme: readable
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# 0. set up

## a. libraries
```{r message = FALSE}
library(tidyverse) # general manipulation
library(here) # organizing directories
library(janitor) # cleaning column names
library(BiodiversityR) # to make rank abundance curve
library(ggrepel) # repel ggplot text labels
```

## b. data

There are four data frames here:  
1. `taxon_nacc`: taxonomic information from the [NACC](http://checklist.americanornithology.org/)  
2. `murci`: Murciélago counts  
3. `leiva`: Leiva counts  
4. `birds`: data frame with both `murci` and `leiva`  

```{r message = FALSE}
# taxon info from NACC
taxon_nacc <- read_csv(here::here("data", "NACC_list_species_2022-01-29.csv"))

# Murcielago
murci <- read_csv(here::here("data", "CRSR_CBC_2021_Murcielago_data_entry.csv")) %>% 
  mutate(sitio = "murci") %>% 
  clean_names() %>% 
  # attach taxonomic info
  left_join(., taxon_nacc, by = c("especie" = "common_name"))

# Leiva
leiva <- read_csv(here::here("data", "CRCA_CBC_2021_Leiva_Sensoria_data_entry.csv")) %>% 
  mutate(sitio = "leiva") %>% 
  clean_names() %>% 
  # attach taxonomic info
  left_join(., taxon_nacc, by = c("especie" = "common_name"))

# Murcielago and Leiva together in one data frame 
birds <- rbind(murci, leiva) 
```

# 1. Observations by family

## a. Leiva

```{r fig.width = 12}
leiva_families <- leiva %>% 
  # summarizing observations by family
  group_by(family) %>% 
  summarize(sum_obs = sum(numero)) %>% 
  ungroup() %>% 
  # set the factor levels to be in descending order by sum_obs
  arrange(-sum_obs) %>% 
  mutate(family = fct_inorder(family))

ggplot(leiva_families,
       aes(x = family, y = sum_obs)) +
  geom_col(aes(fill = family)) +
  geom_text(aes(label = sum_obs), nudge_y = 2) +
  scale_y_continuous(expand = c(0, 0), limits = c(0, 53)) +
  theme_classic() +
  theme(legend.position = "none",
        axis.text.x = element_text(angle = -45, hjust = 0)) +
  labs(x = "Family", y = "Total observations",
       title = "Leiva observations by family")
```

## b. Murciélago

```{r fig.width = 12}
murci_families <- murci %>% 
  # summarizing observations by family
  group_by(family) %>% 
  summarize(sum_obs = sum(numero)) %>% 
  ungroup() %>% 
  # set the factor levels to be in descending order by sum_obs
  arrange(-sum_obs) %>% 
  mutate(family = fct_inorder(family))

ggplot(murci_families,
       aes(x = family, y = sum_obs)) +
  geom_col(aes(fill = family)) +
  geom_text(aes(label = sum_obs), nudge_y = 5) +
  scale_y_continuous(expand = c(0, 0), limits = c(0, 235)) +
  theme_classic() +
  theme(legend.position = "none",
        axis.text.x = element_text(angle = -45, hjust = 0)) +
  labs(x = "Family", y = "Total observations",
       title = "Murciélago observations by family")
```

# 2. Rank abundance

## a. What is a rank abundance curve?

Rank abundance curves are plotted with the proportion (or raw number of) observations for each species on the y-axis, and rank on the x-axis. From these plots, you can glean information about how abundant species were in your data.

## b. Getting the data in order

First, I'll make a data frame to calculate rank abundance where each column is a species (n = 150) and each row is a "site" (n = 2, either "leiva" or "murci"). The cells are filled with the total number of observations for each species.
```{r}
# use the `birds` data frame
birds_ra_df <- birds %>% 
  # select site, species, and number
  select(sitio, especie, numero) %>% 
  # calculate total number of observations per species per site
  group_by(sitio, especie) %>% 
  summarize(sum_obs = sum(numero)) %>% 
  # spread out the data frame so that each column is a species
  pivot_wider(names_from = especie, values_from = sum_obs) %>% 
  column_to_rownames("sitio") %>% 
  # replace any NA with 0
  replace(is.na(.), 0)
```

I'll also make a data frame with the site information: not especially informative, but useful for plotting the data later.

```{r}
# use the `dplyr::tribble()` function
env <- tribble(
  # create one column called "sitio" with "leiva" and "murci"
  ~sitio,
  "leiva",
  "murci") %>% 
  # make sure this is a data.frame
  as.data.frame() %>% 
  # set the factors
  mutate(sitio = as_factor(sitio))
```

## c. Making the plot

I'll use the `BiodiversityR::rankabuncomp()` function to calculate rank abundance for Leiva and Murciélago.

```{r echo = FALSE, message = FALSE}
birds_ra_data <- rankabuncomp(x = birds_ra_df, 
                              y = env, factor = "sitio", 
                              scale = "proportion", 
                              legend = FALSE, specnames = c(1:30),
                              return.data = TRUE)
```

These are the first 10 rows of the output:

```{r}
head(birds_ra_data, 10)
```

I'll plot the curves using the output `birds_ra_data`.

```{r fig.width = 20}
ggplot(birds_ra_data, aes(x = rank, y = proportion)) +
  geom_line(aes(color = Grouping), size = 1) +
  geom_point(aes(color = Grouping), size = 2) +
  geom_text_repel(data = birds_ra_data %>% filter(rank < 10),
                  aes(label = species)) +
  facet_wrap(~ Grouping, scales = "free")
```











